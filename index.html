<!DOCTYPE html>
<html>
<head>
  <title>Streaming with JSONP</title>
</head>
<body>
  <h1>Streaming: Inception</h1>
  <video id="player" controls width="640">
    <source id="source" type="video/mp4">
  </video>

  <script>
    const videoTitle = 'Inception.mkv';               // or .mp4
    const fileId     = '1pxyupX9vV0O8YuDcfGPSxkTnORdFlmx8';
    const mimeType   = videoTitle.endsWith('.mkv')
      ? 'video/x-matroska' : 'video/mp4';

    // set up the video src
    document.getElementById('source').src =
      `https://drive.google.com/uc?export=download&id=${fileId}`;

    // this callback will be invoked by the JSONP script
    function onSheetData(json) {
      // json.feed.entry is an array of rows
      const rows = json.feed.entry.map(e => ({
        title: e.gsx$title.$t,
        time:  parseFloat(e.gsx$timeseconds.$t)
      }));

      // strip extension & match base name
      const base = videoTitle.replace(/\.[^.]+$/, '').toLowerCase();
      let row = rows.find(r => r.title.replace(/\.[^.]+$/, '').toLowerCase() === base);
      if (!row) row = rows[0];  // fallback

      video.currentTime = row.time || 0;
    }

    // inject the JSONP feed script
    const script = document.createElement('script');
    script.src = 
      'https://spreadsheets.google.com/feeds/list/' +
      'YOUR_SPREADSHEET_ID/od6/public/values?' +
      'alt=json-in-script&callback=onSheetData';
    document.body.appendChild(script);

    // save progress (same as before)
    function save(at) {
      fetch('https://hook.eu2.make.com/of3gkqwtwwrjeo32v8vw5r4j3hxs18hf', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ title: videoTitle, time: Math.floor(at), lastWatched: new Date().toISOString() })
      });
    }
    const video = document.getElementById('player');
    video.addEventListener('pause', () => save(video.currentTime));
    video.addEventListener('ended', () => save(video.duration));
  </script>
</body>
</html>
